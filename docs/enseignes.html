<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enseignes — Notoriété & image</title>
<style>
  :root{--bg:#fff;--surface:#fff;--surface-alt:#f5f5f7;--text:#1d1d1f;--muted:#6e6e73;--border:#e5e5ea;
        --accent:#0a84ff;--ok:#34c759;--warn:#ffd60a;--err:#ff3b30}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{max-width:980px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);z-index:10}
  .hwrap{display:flex;align-items:end;justify-content:space-between;gap:12px;padding:14px 20px}
  h1{font-size:20px;font-weight:700;letter-spacing:-.01em;margin:0}
  .sub{color:var(--muted);font-size:13px;margin:4px 0 0}

  section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:12px}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .cols-2{grid-template-columns:1fr 1fr}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid #d2d2d7;background:#fff}
  .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
  .title{font-weight:600}
  .muted{color:var(--muted);font-size:13px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #d2d2d7;background:var(--surface-alt);cursor:pointer}
  .btn:hover{background:#ebebf0}
  .pill{display:inline-block;padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;margin-right:6px;font-size:12px}
  pre{background:var(--surface-alt);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto;max-height:420px}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .divider{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="hwrap container">
    <div>
      <h1>Enseignes — Notoriété & image</h1>
      <p class="sub">Liste des fiches dans <code>/enseignes/*.json</code> et affichage du détail (+ <code>.md</code> si présent).</p>
    </div>
    <div class="row">
      <a class="btn" href="index.html">Saisie</a>
      <a class="btn" href="viewer.html">Viewer</a>
    </div>
  </div>
</header>

<main class="container">
  <section>
    <div class="grid cols-2" style="align-items:end">
      <div>
        <div class="title">Filtrer</div>
        <input id="q" placeholder="Rechercher une enseigne…" />
        <div class="muted" style="margin-top:6px">Tapez au moins 2 caractères.</div>
      </div>
      <div class="muted" style="text-align:right" id="count">–</div>
    </div>
    <div id="cards" class="grid cols-3" style="margin-top:12px"></div>
  </section>

  <section id="detail" style="display:none">
    <div class="grid cols-2">
      <div>
        <div class="title" id="d_name">—</div>
        <div class="muted" id="d_group" style="margin-top:4px"></div>
        <div style="margin-top:8px" id="d_chips"></div>
        <div class="divider"></div>
        <div class="muted" id="d_positionnement"></div>
        <div class="divider"></div>
        <div id="d_refs"></div>
      </div>
      <div>
        <div class="title">Fichier .md (synthèse)</div>
        <div class="muted">Source : <a id="mdLink" target="_blank" rel="noopener">ouvrir sur GitHub</a></div>
        <div class="divider"></div>
        <pre id="mdView">(aucun .md pour cette enseigne)</pre>
      </div>
    </div>
  </section>
</main>

<script>
const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
const API = (p)=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
const RAW = (p)=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p}`;
const $=s=>document.querySelector(s);

async function listEnseignes(){
  const r = await fetch(API('enseignes'));
  if(!r.ok) throw new Error('GitHub API '+r.status);
  const arr = await r.json();
  return arr.filter(x=>x.name.endsWith('.json')).map(x=>x.download_url);
}
async function loadJson(url){
  const r = await fetch(url); if(!r.ok) throw new Error('GET json '+r.status);
  return await r.json();
}
async function loadMd(slug){
  const raw = RAW(`enseignes/${slug}.md`);
  const r = await fetch(raw);
  if(r.ok) return await r.text();
  // fallback via contents API (si repo branch protégé)
  const rr = await fetch(API(`enseignes/${slug}.md`));
  if(!rr.ok) return null;
  const d = await rr.json();
  if(d && d.download_url){ const r3 = await fetch(d.download_url); return await r3.text(); }
  return null;
}

function chip(txt){ const s=document.createElement('span'); s.className='pill'; s.textContent=txt; return s; }

function renderCards(items){
  const cont = $('#cards'); cont.innerHTML='';
  const qv = ($('#q').value||'').trim().toLowerCase();
  const filtered = items.filter(it=>{
    if(qv.length<2) return true;
    const hay = `${it.nom||''} ${it.slug||''} ${it.slogan_signature||''} ${it.positionnement||''}`.toLowerCase();
    return hay.includes(qv);
  });
  $('#count').textContent = `${filtered.length} enseigne(s)`;
  filtered.sort((a,b)=> (a.nom||'').localeCompare(b.nom||'', 'fr', {sensitivity:'base'}));
  for(const it of filtered){
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="title">${it.nom||it.slug}</div>
      <div class="muted" style="margin:4px 0 6px">${it.slogan_signature||''}</div>
      <div class="muted">${it.positionnement||''}</div>
      <div style="margin:10px 0" id="chips-${it.slug}"></div>
      <button class="btn" data-slug="${it.slug}">Voir la fiche</button>
    `;
    cont.appendChild(card);
    const chips = document.getElementById(`chips-${it.slug}`);
    (it.territoires_image||[]).slice(0,3).forEach(t=> chips.appendChild(chip(t)));
  }
  cont.querySelectorAll('button[data-slug]').forEach(btn=>{
    btn.addEventListener('click', ()=> showDetail(btn.getAttribute('data-slug'), items));
  });
}

async function showDetail(slug, items){
  const it = items.find(x=>x.slug===slug); if(!it) return;
  // Titre / groupe
  $('#d_name').textContent = it.nom || slug;
  $('#d_group').textContent = it.marque_groupe || '';
  // Chips (territoires d'image)
  const ch = document.getElementById('d_chips'); ch.innerHTML='';
  (it.territoires_image||[]).forEach(t=> ch.appendChild(chip(t)));
  // Positionnement
  $('#d_positionnement').textContent = it.positionnement || '';
  // Références
  const refs = document.getElementById('d_refs'); refs.innerHTML = '<div class="title">Références</div>';
  const ul = document.createElement('ul'); ul.className='muted';
  (it.references||[]).forEach(r=>{
    const li = document.createElement('li');
    const a = document.createElement('a'); a.href = r.url; a.target='_blank'; a.rel='noopener'; a.textContent = r.label || r.url;
    li.appendChild(a);
    ul.appendChild(li);
  });
  refs.appendChild(ul);

  // Markdown de synthèse
  const md = await loadMd(slug);
  const mdView = document.getElementById('mdView');
  const mdLink = document.getElementById('mdLink');
  if(md){
    mdView.textContent = md;
    mdLink.href = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/enseignes/${slug}.md`;
  }else{
    mdView.textContent = '(aucun .md pour cette enseigne)';
    mdLink.href = `https://github.com/${OWNER}/${REPO}/tree/${BRANCH}/enseignes`;
  }

  document.getElementById('detail').style.display='block';
}

(async function boot(){
  try{
    const urls = await listEnseignes();
    const items = [];
    for(const u of urls){
      try{ items.push(await loadJson(u)); }catch(e){}
    }
    renderCards(items);
    document.getElementById('q').addEventListener('input', ()=> renderCards(items));
  }catch(e){
    document.getElementById('cards').innerHTML = '<div class="muted">Impossible de charger les enseignes (GitHub API).</div>';
    console.error(e);
  }
})();
</script>
</body>
</html>
