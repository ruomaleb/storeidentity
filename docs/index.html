<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil Magasin — Saisie & Résultats</title>
  <style>
    :root{
      --bg:#ffffff;--surface:#ffffff;--surface-alt:#f5f5f7;--text:#1d1d1f;--muted:#6e6e73;--border:#e5e5ea;--accent:#0a84ff;--ok:#34c759;--warn:#ffd60a;--err:#ff3b30
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:1024px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);z-index:10}
    h1{font-size:20px;margin:0 0 4px}
    .sub{color:var(--muted);font-size:12px;margin:0}
    section{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin-top:16px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:1fr 1fr 1fr}
    label{display:block;font-weight:600;margin-bottom:6px}
    .help{margin-top:6px;color:var(--muted);font-size:12px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #d2d2d7;background:#fff;color:var(--text);font-size:14px}
    input:focus,textarea:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(10,132,255,.25);border-color:var(--accent)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #d2d2d7;background:var(--surface-alt);color:var(--text);cursor:pointer}
    .btn:hover{background:#ededf1}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--surface-alt);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--text)}
    .err{color:var(--err)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .list{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .item{padding:10px 12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:12px;align-items:center}
    .item:first-child{border-top:none}
    .item a{color:var(--accent);text-decoration:none}
    .item a:hover{text-decoration:underline}
    pre{background:#0a0f1a;color:#e6eefc;border-radius:12px;padding:12px;overflow:auto;max-height:420px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="container" style="padding:12px 24px;">
      <h1>Profil Magasin — saisie + résultats</h1>
      <p class="sub">Saisie minimale (schéma « valeur + provenance ») + accès aux profils générés par le workflow n8n.</p>
    </div>
  </header>

  <main class="container">
    <!-- Étape 0 — Enseigne + Type d’opération -->
    <section>
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Étape 0 — Contexte</strong>
        <span class="pill">Enseigne + Type d’opération</span>
      </div>
      <div class="grid cols-2">
        <div>
          <label for="enseigneSelect">Nom de l’enseigne</label>
          <select id="enseigneSelect"></select>
          <div class="help">Liste alimentée depuis <code>/enseignes/*.json</code> du dépôt. Valeur affichée = champ <code>nom</code> du JSON.</div>
        </div>
        <div>
          <label for="operation">Type d’opération</label>
          <select id="operation">
            <option value="ouverture">Ouverture</option>
            <option value="anniversaire">Anniversaire</option>
            <option value="evenement_special">Événement spécial</option>
            <option value="saisonnier">Opération saisonnière</option>
            <option value="autre" selected>Autre</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Étape 1 — Recherche Google Places (nouvelle API) -->
    <section>
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Étape 1 — Recherche magasin (Google Places)</strong>
        <span class="pill">AutocompleteSuggestion + Place.fetchFields</span>
      </div>

      <div class="row" style="gap:8px">
        <input id="placeQuery" placeholder="Tapez le nom + ville (ex. : Super U Wormhout)" autocomplete="off" style="flex:1" />
        <button class="btn" id="btnPlacesSearch" type="button">Rechercher</button>
        <span class="muted" id="placesStatus">Saisissez puis cliquez « Rechercher ».</span>
      </div>
      <div id="placesResults" class="list" style="display:none;margin-top:8px"></div>
      <div class="help">En cas d’absence de résultats, vérifiez que votre clé autorise **Maps JavaScript API** et **Places API** pour le référent GitHub Pages.</div>
      <div class="divider"></div>

      <!-- Champs préremplis après sélection -->
      <div class="grid cols-2">
        <div>
          <label for="magasin">Nom du magasin</label>
          <input id="magasin" placeholder="Ex : Super U Wormhout" maxlength="120" />
        </div>
        <div>
          <label for="url">Page web du magasin (site de l’enseigne)</label>
          <input id="url" placeholder="https://www.enseigne.fr/magasins/ville…" />
        </div>
        <div class="cols-2" style="grid-column:1/-1;display:grid;gap:12px;grid-template-columns:1fr 1fr">
          <div>
            <label for="adresse">Adresse postale</label>
            <input id="adresse" placeholder="Numéro, voie, CP Ville" />
          </div>
          <div>
            <label for="coords">Coordonnées GPS — lat, lng</label>
            <input id="coords" placeholder="48.11552771157894, -1.6767288891938714" />
          </div>
        </div>
      </div>
    </section>

    <!-- Étape 2 — Webhook + JSON -->
    <section>
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Étape 2 — Génération & Envoi</strong>
        <span class="pill">Webhook n8n</span>
      </div>

      <label for="webhook">URL du webhook n8n (POST JSON)</label>
      <input id="webhook" value="https://n8n.wondermi.agency/webhook-test/397d1869-432d-4f3f-a9a4-f1c53ce9a4c2" />
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn-gen-secret" type="button">Générer un secret</button>
        <span class="help">Construit une URL du type <code>…/webhook/store-profile/&lt;secret&gt;</code>. Remplacez <code>/webhook-test/</code> par <code>/webhook/</code> en prod.</span>
      </div>

      <div id="errors" class="help err" style="margin-top:8px;display:none"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btn-gen">Valider & générer le JSON</button>
        <button class="btn" id="btn-copy" disabled>Copier</button>
        <button class="btn warn" id="btn-dl" disabled>Télécharger JSON</button>
        <button class="btn ok" id="btn-post" disabled>Envoyer au webhook n8n</button>
      </div>

      <div class="divider"></div>
      <pre id="preview">(générez le JSON pour prévisualiser ici)</pre>
    </section>

    <!-- Étape 3 — Résultats du workflow (accès) -->
    <section>
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Étape 3 — Résultats récents</strong>
        <span class="pill">/profiles/ · viewer.html</span>
      </div>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input id="viewerId" placeholder="Saisir un store_id pour ouvrir le viewer (ex. sample-superu-wormhout)" style="flex:1" />
        <a class="btn" id="btnOpenViewer" href="#" target="_blank" rel="noopener">Ouvrir dans le viewer</a>
        <a class="btn" href="https://github.com/ruomaleb/storeidentity/tree/main/profiles" target="_blank" rel="noopener">Voir tout sur GitHub</a>
      </div>
      <div id="resultsBox" class="list" style="display:none"></div>
      <div class="help">Cliquez un élément pour ouvrir <code>viewer.html</code>. Le tri se fait sur <code>last_updated</code> s’il est présent dans le JSON.</div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);

    // -------------------------
    // 0) Constantes du dépôt
    // -------------------------
    const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
    const GH_API = (p)=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
    const toRaw  = (p)=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p.replace(/^\\/+/, '')}`;

    // -------------------------
    // 1) Enseignes (menu déroulant)
    // -------------------------
    async function loadEnseignes(){
      const sel = $('#enseigneSelect');
      try{
        const r = await fetch(GH_API('enseignes'));
        if(!r.ok) throw new Error('GitHub API '+r.status);
        const items = await r.json();
        const jsons = items.filter(it=>/\\.json$/i.test(it.name));
        const out = [];
        for(const it of jsons){
          try{
            const jr = await fetch(it.download_url);
            if(!jr.ok) continue;
            const j = await jr.json();
            const slug = j.slug || it.name.replace(/\\.json$/,'');
            const nom  = j.nom  || slug;
            out.push({slug, nom});
          }catch(e){}
        }
        out.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
        sel.innerHTML = '<option value=\"\">— choisir —</option>' + out.map(e=>`<option value=\"${e.slug}\">${e.nom}</option>`).join('');
      }catch(e){
        sel.innerHTML = '<option value=\"\">— choisir —</option><option>Super U</option><option>Intersport</option><option>E.Leclerc</option>';
      }
    }

    // -------------------------
    // 2) Google Places (nouvelle API)
    // -------------------------
    let placesLib=null, sessionToken=null;
    const placesStatus = (msg, type='info')=>{
      const el=$('#placesStatus'); if(!el) return;
      el.textContent=msg; el.style.color=(type==='err'?'#ff3b30':'#6e6e73');
    };
    async function ensurePlacesReady(){
      if(!window.google || !google.maps || !google.maps.importLibrary){
        // petite attente si le script se termine de charger
        for(let i=0;i<15 && (!window.google || !google.maps || !google.maps.importLibrary);i++){
          await new Promise(r=>setTimeout(r,100));
        }
      }
      if(!placesLib){
        placesLib = await google.maps.importLibrary('places');
        sessionToken = new placesLib.AutocompleteSessionToken();
      }
      return placesLib;
    }
    function renderSuggestions(sugs=[]){
      const box = $('#placesResults');
      if(!sugs.length){ box.style.display='none'; box.innerHTML=''; return; }
      box.innerHTML = sugs.map((s,i)=>{
        const p = s.placePrediction || s;
        const txt = p?.text || p?.structuredFormat?.mainText || 'Résultat';
        const sec = p?.structuredFormat?.secondaryText || '';
        return `<div class="item" data-i="${i}">
                  <div><strong>${txt}</strong>${sec?`<div class="muted">${sec}</div>`:''}</div>
                  <a href="#" data-i="${i}">Sélectionner</a>
                </div>`;
      }).join('');
      box.style.display='block';
      [...box.querySelectorAll('a')].forEach(a=>{
        a.onclick = (e)=>{ e.preventDefault(); onPickSuggestion(sugs[+a.dataset.i]); };
      });
    }
    async function searchPlaces(){
      const q = ($('#placeQuery')?.value || '').trim();
      if(!q){ placesStatus('Saisissez une requête (ex. « Super U Wormhout »).','err'); return; }
      try{
        await ensurePlacesReady();
        if(!sessionToken) sessionToken = new placesLib.AutocompleteSessionToken();
        const { suggestions } = await placesLib.AutocompleteSuggestion.fetchAutocompleteSuggestions({
          input:q, language:'fr', region:'FR', sessionToken
        });
        if(!suggestions?.length){
          placesStatus('Aucun résultat. Ajoutez une ville ou vérifiez la clé/quotas.','err');
          renderSuggestions([]); return;
        }
        placesStatus('Résultats prêts — choisissez un lieu.');
        renderSuggestions(suggestions);
      }catch(e){
        placesStatus('Erreur d’appel Places (clé/référents/API).','err');
        renderSuggestions([]);
      }
    }
    async function onPickSuggestion(sug){
      try{
        await ensurePlacesReady();
        const p = sug.placePrediction || sug;
        const placeId = p?.placeId || p?.id || p?.place?.id;
        if(!placeId) throw new Error('placeId manquant');

        const place = new placesLib.Place({ id: placeId, language:'fr' });
        const fields = ['displayName','formattedAddress','location','websiteUri','googleMapsURI'];
        await place.fetchFields({ fields });

        // remplissage des champs
        $('#magasin').value = place.displayName?.text || $('#magasin').value;
        $('#adresse').value = place.formattedAddress || $('#adresse').value;
        if(place.location){ $('#coords').value = `${place.location.lat()}, ${place.location.lng()}` }
        $('#url').value = place.websiteUri || place.googleMapsURI || $('#url').value;

        // nouvelle session pour la prochaine recherche
        sessionToken = null;
        $('#placesResults').style.display='none';
        placesStatus('Lieu sélectionné ✔︎ (champs préremplis).');
      }catch(e){
        placesStatus('Impossible de récupérer les détails du lieu.','err');
      }
    }

    // -------------------------
    // 3) Génération / Webhook
    // -------------------------
    let lastPayloadStr=null, lastPayloadObj=null;
    function uuidv4(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
    const DEFAULT_WEBHOOK='https://n8n.wondermi.agency/webhook-test/397d1869-432d-4f3f-a9a4-f1c53ce9a4c2';
    function randomHex(len=32){const out=new Uint8Array(len/2); if(window.crypto?.getRandomValues) crypto.getRandomValues(out); else for(let i=0;i<out.length;i++) out[i]=Math.floor(Math.random()*256); return Array.from(out,b=>b.toString(16).padStart(2,'0')).join('')}
    function generateWebhookSecret(){
      const i=$('#webhook'); if(!i) return;
      let base=(i.value||'').trim(); if(!base){ base=prompt('Base du webhook n8n','https://n8n.wondermi.agency/webhook/store-profile')||'' }
      base=base.trim().replace(/\\/+$/,''); const secret=randomHex(32); const url=base+'/'+secret; i.value=url; try{localStorage.setItem('webhook_url',url)}catch{}
    }
    (function(){ const i=$('#webhook'); if(i){ try{ i.value=localStorage.getItem('webhook_url')||i.value||DEFAULT_WEBHOOK }catch(e){ if(!i.value) i.value=DEFAULT_WEBHOOK } $('#btn-gen-secret')?.addEventListener('click', generateWebhookSecret)} })();

    function parseLatLng(s){
      if(!s) return null;
      let p=s.split(','); if(p.length!==2){ p=s.split(';'); }
      if(p.length!==2){ p=s.trim().split(' ').filter(Boolean) }
      if(p.length!==2) return null;
      const lat=parseFloat((p[0]||'').replace(',','.')); const lng=parseFloat((p[1]||'').replace(',','.'));
      if(Number.isNaN(lat)||Number.isNaN(lng)) return null; return {lat,lng};
    }
    function validateInputs(){
      const enseigneSel=$('#enseigneSelect'); const enseigne=(enseigneSel && enseigneSel.options[enseigneSel.selectedIndex]?.text || '').trim();
      const operation=$('#operation').value||'autre';
      const magasin=$('#magasin').value.trim();
      const adresse=$('#adresse').value.trim();
      const url=$('#url').value.trim();
      const coords=parseLatLng($('#coords').value.trim());
      const errs=[];
      if(!enseigne) errs.push('• Nom de l’enseigne requis');
      if(!magasin) errs.push('• Nom du magasin requis');
      if(!adresse) errs.push('• Adresse postale requise');
      if(!/^https?:\\/\\//i.test(url)) errs.push('• URL de la page magasin invalide (http/https)');
      if(!coords) errs.push('• Coordonnées GPS invalides (lat, lng)');
      return { ok:errs.length===0, errs, values:{ enseigne, operation, magasin, adresse, url, lat:coords?.lat, lng:coords?.lng } }
    }
    function defaultSource(url){ return { type:'open_web', name:'Site enseigne', url, collected_at:new Date().toISOString() } }
    function buildJSON(v){
      const src=defaultSource(v.url); const now=new Date().toISOString();
      return {
        store_id: uuidv4(),
        enseigne: v.enseigne,
        store_name: v.magasin,
        last_updated: now,
        goal: 'hybride',
        operation_type: v.operation||'autre',
        axes: {
          adresse_contexte: {
            adresse_postale: { value: v.adresse, sources: [src] },
            coordonnees: {
              latitude:  { value: v.lat, sources: [src] },
              longitude: { value: v.lng, sources: [src] }
            },
            references_ouvertes: [
              { page_type:'page_magasin_enseigne', title:`${v.magasin} — ${v.enseigne}`, language:'fr', url:v.url, source:src, collected_at: now }
            ]
          }
        }
      }
    }
    function download(filename, text){ const blob=new Blob([text],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href) }
    async function postToWebhook(){
      const webhook=($('#webhook')?.value||'').trim(); if(!/^https?:\\/\\//i.test(webhook)){ alert('URL du webhook n8n invalide'); return }
      let payloadStr=lastPayloadStr; if(!payloadStr){ const r=validateInputs(); if(!r.ok){ alert('Corrigez les erreurs puis regénérez.'); return } const obj=buildJSON(r.values); payloadStr=JSON.stringify(obj); lastPayloadObj=obj; lastPayloadStr=payloadStr }
      try{
        try{ localStorage.setItem('webhook_url',webhook) }catch{}
        const resp=await fetch(webhook,{ method:'POST', headers:{'content-type':'application/json'}, body:payloadStr, mode:'cors', credentials:'omit' });
        if(resp.ok){ alert('Webhook envoyé ✅'); return } else { console.warn('CORS/HTTP non OK, fallback Beacon :', resp.status, await resp.text().catch(()=>'')) }
      }catch(err){ console.warn('fetch échoué, fallback Beacon :', err) }
      try{ const ok=navigator.sendBeacon(webhook,new Blob([payloadStr],{type:'text/plain;charset=UTF-8'})); alert(ok?'Webhook envoyé (Beacon) ✅':'Échec d’envoi (Beacon)') }catch(e){ alert('Échec total : '+(e?.message||e)) }
    }
    $('#btn-gen').addEventListener('click', ()=>{
      const r=validateInputs(); const $err=$('#errors');
      if(!r.ok){ $err.style.display='block'; $err.innerText=r.errs.join('\\n'); $('#preview').textContent='(corrigez les erreurs puis regénérez)'; $('#btn-copy').disabled=true; $('#btn-dl').disabled=true; $('#btn-post').disabled=true; return }
      $err.style.display='none';
      const json=buildJSON(r.values); const pretty=JSON.stringify(json,null,2);
      lastPayloadObj=json; lastPayloadStr=pretty;
      $('#preview').textContent=pretty;
      $('#btn-copy').disabled=false; $('#btn-dl').disabled=false; $('#btn-post').disabled=false;
      $('#btn-copy').onclick=async()=>{ try{ await navigator.clipboard.writeText(pretty); alert('JSON copié') }catch{ alert('Copie impossible') } }
      $('#btn-dl').onclick=()=>download(`store_profile_${r.values.enseigne.replace(/\\s+/g,'_')}.json`, pretty);
      $('#btn-post').onclick=postToWebhook;
    });

    // -------------------------
    // 4) Résultats du workflow (liste)
    // -------------------------
    async function loadRecentProfiles(){
      const box=$('#resultsBox'); box.innerHTML=''; box.style.display='none';
      try{
        const r=await fetch(GH_API('profiles')); if(!r.ok) throw new Error('GitHub API '+r.status);
        const items=(await r.json()).filter(it=>/\\.json$/i.test(it.name));
        // on limite le nombre de fetch pour éviter le rate limit
        const first=items.slice(0,25);
        const rows=[];
        for(const it of first){
          try{
            const j=await fetch(it.download_url).then(r=>r.json());
            const id=j.store_id || it.name.replace(/\\.json$/,'');
            const t=j.last_updated || '';
            const enseigne=j.enseigne || '';
            const sn=j.store_name || '';
            rows.push({id, file:it.name, when:t, enseigne, store:sn});
          }catch(e){}
        }
        rows.sort((a,b)=> (b.when||'').localeCompare(a.when||''));
        if(!rows.length){ box.innerHTML='<div class="item"><div>Aucun profil trouvé</div></div>'; box.style.display='block'; return; }
        box.innerHTML = rows.map(r=>{
          const vId = encodeURIComponent(r.id);
          const hrefId = `viewer.html?id=${vId}`;
          const hrefPath = `viewer.html?json=${encodeURIComponent('profiles/'+r.file)}&md=${encodeURIComponent('profiles/'+r.file.replace(/\\.json$/,'.md'))}`;
          const title = (r.store?`${r.store} — `:'') + (r.enseigne||'');
          const when = r.when ? new Date(r.when).toLocaleString('fr-FR') : '—';
          return `<div class="item">
                    <div>
                      <div><strong>${title || r.file}</strong></div>
                      <div class="muted">ID: ${r.id} · MAJ: ${when}</div>
                    </div>
                    <div class="row">
                      <a class="btn" href="${hrefId}" target="_blank" rel="noopener">Viewer (id)</a>
                      <a class="btn" href="${hrefPath}" target="_blank" rel="noopener">Viewer (chemins)</a>
                    </div>
                  </div>`;
        }).join('');
        box.style.display='block';
      }catch(e){
        box.innerHTML='<div class="item"><div>Impossible de charger la liste des profils (GitHub API). Ouvrez le dossier <a href="https://github.com/ruomaleb/storeidentity/tree/main/profiles" target="_blank" rel="noopener">profiles</a>.</div></div>';
        box.style.display='block';
      }
    }

    // -------------------------
    // 5) Boot
    // -------------------------
    document.addEventListener('DOMContentLoaded', ()=>{
      loadEnseignes();
      loadRecentProfiles();

      // Recherche Places
      $('#btnPlacesSearch')?.addEventListener('click', searchPlaces);

      // Viewer direct par ID
      $('#btnOpenViewer')?.addEventListener('click', (e)=>{
        e.preventDefault();
        const id=($('#viewerId')?.value||'').trim(); if(!id) return;
        window.open(`viewer.html?id=${encodeURIComponent(id)}`,'_blank','noopener');
      });
    });
  </script>

  <!-- Google Maps JS + Places (nouvelle API) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCy5VImTf6SPltnHqVetqh5GPCp-o_JmFo&libraries=places&language=fr&region=FR&loading=async">
  </script>
</body>
</html>
