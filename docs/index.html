<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil Magasin — Saisie avec Enseigne + Google Places</title>
  <style>
    :root{
      --bg:#0b1320;--card:#121a2b;--muted:#7c8aa5;--text:#e6eefc;--accent:#4f8cff;--ok:#10b981;--warn:#f59e0b;--err:#ef4444
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg) 0%,#0f172a 100%);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    a{color:#9cc1ff}
    .container{max-width:980px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:rgba(11,19,32,.85);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #1f2a44}
    h1{font-size:18px;margin:0 0 4px}
    .sub{color:#c7d7ff80;font-size:12px;margin:0}
    section{background:var(--card);border:1px solid #23304d;border-radius:16px;padding:16px;margin-top:16px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    label{display:block;font-weight:600;margin-bottom:6px}
    .help{margin-top:6px;color:#c7d7ff80;font-size:12px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a395c;background:#0e1526;color:#fff;font-size:14px}
    input:focus,textarea:focus,select:focus{outline:2px solid #365da8;outline-offset:0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a395c;background:#0b1320;color:#fff;cursor:pointer}
    .btn:hover{border-color:#4b608f}
    .btn.primary{background:#4169e1;border-color:#4169e1}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#000}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #223156;background:#132038;border-radius:999px;padding:4px 10px;font-size:12px;color:#cfe0ff}
    .err{color:#fecaca}
    pre{background:#0a1120;border:1px solid #1f2a44;border-radius:12px;padding:12px;overflow:auto;max-height:420px}
    .divider{height:1px;background:#1f2a44;margin:12px 0}
    .skeleton{background:linear-gradient(90deg,#10203a 25%,#0d1a2e 37%,#10203a 63%);background-size:400% 100%;animation:s 1.4s ease infinite;border-radius:8px}
    @keyframes s{0%{background-position:100% 0}100%{background-position:-100% 0}}
  </style>
</head>
<body>
  <header>
    <div class="container" style="padding:12px 24px;">
      <h1>Profil Magasin — enseigne + Google Places</h1>
      <p class="sub">Sélectionnez une <strong>enseigne</strong>, choisissez le <strong>magasin</strong> via Google Places, et précisez le <strong>type d’opération</strong>. Le JSON est aligné sur le schéma (valeur + provenance).</p>
    </div>
  </header>

  <main class="container">
    <!-- ÉTAPE 1 — Saisie guidée -->
    <section>
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <strong>Étape 1 — Enseigne, Magasin (Google Places), Opération</strong>
        <span class="pill" id="repoInfo">enseigne : chargement…</span>
      </div>

      <div class="grid cols-2">
        <!-- A) Enseigne -->
        <div>
          <label for="enseigneSelect">Enseigne</label>
          <select id="enseigneSelect"></select>
          <div class="help">Liste alimentée depuis <code>enseignes/*.json</code> du dépôt GitHub.</div>
        </div>

        <!-- B) Opération -->
        <div>
          <label for="operationType">Type d’opération</label>
          <select id="operationType">
            <option value="ouverture">ouverture</option>
            <option value="anniversaire">anniversaire</option>
            <option value="reouverture_travaux">reouverture_travaux</option>
            <option value="demenagement">demenagement</option>
            <option value="relooking">relooking</option>
            <option value="operation_saisonniere">operation_saisonniere</option>
            <option value="operation_promotionnelle">operation_promotionnelle</option>
            <option value="autre" selected>autre</option>
          </select>
          <div class="help">Sélectionnez le contexte marketing principal de l’opération.</div>
        </div>

        <!-- C) Recherche Google Places -->
        <div style="grid-column:1/-1">
          <label for="placeSearch">Magasin (Google Places)</label>
          <input id="placeSearch" placeholder="Tapez le nom et la ville (ex : Super U Wormhout)…" autocomplete="off" />
          <div class="help">Autocomplete (type <em>establishment</em>, pays : FR). Sélectionnez un résultat pour préremplir le profil.</div>
        </div>

        <!-- D) Libellés et dates d’opération -->
        <div>
          <label for="operationLabel">Libellé libre (ex : « Anniv 5 ans », « Réouverture »)</label>
          <input id="operationLabel" placeholder="facultatif" />
        </div>
        <div class="grid cols-2">
          <div>
            <label for="opStart">Date début</label>
            <input id="opStart" type="date" />
          </div>
          <div>
            <label for="opEnd">Date fin</label>
            <input id="opEnd" type="date" />
          </div>
        </div>

        <!-- E) Nom magasin (override) -->
        <div style="grid-column:1/-1">
          <label for="storeName">Nom du magasin (si différent de Google Places)</label>
          <input id="storeName" placeholder="ex : Super U Wormhout (Centre)" />
          <div class="help">Par défaut, on utilise <code>place.name</code>. Vous pouvez le remplacer ici si besoin.</div>
        </div>
      </div>

      <!-- F) Résumé Google Places -->
      <div class="divider"></div>
      <div id="placeSummary" style="display:none">
        <strong>Résumé Google Places</strong>
        <div id="placeSummaryBody" class="help" style="margin-top:6px"></div>
      </div>

      <!-- G) Webhook -->
      <div class="divider"></div>
      <div style="grid-column:1/-1">
        <label for="webhook">URL du webhook n8n (POST JSON)</label>
        <input id="webhook" placeholder="https://votre-n8n.tld/webhook/store-profile" value="https://n8n.wondermi.agency/webhook-test/397d1869-432d-4f3f-a9a4-f1c53ce9a4c2" />
        <div class="help">Votre serveur n8n doit autoriser l’origine (CORS) <code>https://ruomaleb.github.io</code>.</div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btn-gen-secret" type="button">Générer un secret</button>
          <span class="help">Construit une URL du type <code>…/webhook/store-profile/&lt;secret&gt;</code>. En prod, utilisez <code>/webhook/</code>.</span>
        </div>
      </div>

      <!-- H) Actions -->
      <div id="errors" class="help err" style="margin-top:8px;display:none"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btn-gen">Valider & générer le JSON</button>
        <button class="btn" id="btn-copy" disabled>Copier</button>
        <button class="btn warn" id="btn-dl" disabled>Télécharger JSON</button>
        <button class="btn ok" id="btn-post" disabled>Envoyer au webhook n8n</button>
      </div>
      <div id="status" class="help" style="margin-top:8px;display:none"></div>
      <div id="results" class="help" style="margin-top:6px;display:none"></div>
    </section>

    <!-- ÉTAPE 2 — Prévisualisation -->
    <section>
      <strong>Étape 2 — Prévisualisation</strong>
      <div class="divider"></div>
      <pre id="preview">(générez le JSON pour prévisualiser ici)</pre>
    </section>

    <!-- Aide schéma -->
    <section>
      <strong>Rappel de mappage vers le schéma</strong>
      <div class="divider"></div>
      <ul style="margin:0 0 8px 16px;line-height:1.6">
        <li><code>enseigne</code> ⇐ select enseigne (valeur lisible)</li>
        <li><code>store_name</code> ⇐ override ou <code>place.name</code></li>
        <li><code>axes.adresse_contexte.google_places</code> ⇐ détails Places (id, url, website, etc.)</li>
        <li><code>axes.adresse_contexte.coordonnees</code> ⇐ <code>geometry.location</code></li>
        <li><code>axes.adresse_contexte.adresse_postale.value</code> ⇐ <code>formatted_address</code></li>
        <li><code>axes.adresse_contexte.references_ouvertes</code> ⇐ site magasin + lien Google Maps</li>
        <li><code>operation</code> ⇐ type, label, dates</li>
      </ul>
    </section>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);

    // --- Constantes dépôt GitHub (liste des enseignes)
    const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
    const API = (p)=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
    const RAW = (p)=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p}`;

    // --- Mémoires
    let lastPayloadStr = null;
    let lastPayloadObj = null;
    let lastPlace = null; // Place Details complet
    let enseignes = [];   // [{slug, nom}]

    // UUID v4 simple
    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
        const r = Math.random()*16|0, v = c==='x'? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    // Webhook secret
    function randomHex(len=32){
      const out = new Uint8Array(len/2);
      if(window.crypto?.getRandomValues) window.crypto.getRandomValues(out);
      else for(let i=0;i<out.length;i++) out[i] = Math.floor(Math.random()*256);
      return Array.from(out, b=>b.toString(16).padStart(2,'0')).join('');
    }
    function generateWebhookSecret(){
      const input = $('#webhook'); if(!input) return;
      let base = (input.value || '').trim();
      if(!base){
        base = prompt('Base du webhook n8n (ex: https://n8n.wondermi.agency/webhook/store-profile)', 'https://n8n.wondermi.agency/webhook/store-profile') || '';
      }
      base = base.trim().replace(/\/+$/,'');
      const secret = randomHex(32);
      const url = base + '/' + secret;
      input.value = url;
      try { localStorage.setItem('webhook_url', url) } catch(e){}
    }

    // Status helpers
    function setStatus(msg,type='info'){
      const el = $('#status'); if(!el) return;
      el.style.display='block';
      el.textContent = msg;
      el.style.color = (type==='ok') ? '#a7f3d0' : (type==='err' ? '#fecaca' : '#c7d7ff');
    }
    function showResults(html){
      const el = $('#results'); if(!el) return;
      el.style.display='block';
      el.innerHTML = html;
    }

    // --- Chargement des enseignes depuis le dépôt
    async function loadEnseignes(){
      try{
        $('#repoInfo').textContent = `${OWNER}/${REPO}@${BRANCH} — enseignes`;
        const r = await fetch(API('enseignes'));
        if(!r.ok){ throw new Error('GitHub API error '+r.status); }
        const arr = await r.json();
        const files = arr.filter(x=>x.name.endsWith('.json'));
        // Petit fetch de chaque JSON pour récupérer 'nom' et 'slug'
        const out = [];
        for(const f of files){
          try{
            const jr = await fetch(f.download_url);
            if(!jr.ok) continue;
            const j = await jr.json();
            const slug = j.slug || f.name.replace(/\.json$/,'');
            const nom  = j.nom || slug;
            out.push({slug, nom});
          }catch(e){}
        }
        enseignes = out.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
        const sel = $('#enseigneSelect');
        sel.innerHTML = enseignes.map(e=>`<option value="${e.slug}">${e.nom}</option>`).join('');
      }catch(e){
        $('#repoInfo').textContent = 'enseigne : fallback';
        const sel = $('#enseigneSelect');
        sel.innerHTML = `<option value="autre">Autre (saisie libre)</option>`;
      }
    }

    // --- Google Places
    let autocomplete, placesService;
    function initPlaces(){
      const input = $('#placeSearch');
      if(!input || !window.google || !google.maps?.places) return;
      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],
        componentRestrictions: { country: ['fr'] },
        fields: ['place_id','name'] // on récupère le minimum, puis Details pour le reste
      });
      placesService = new google.maps.places.PlacesService(document.createElement('div'));
      autocomplete.addListener('place_changed', onPlaceChanged);
    }

    function onPlaceChanged(){
      const p = autocomplete.getPlace();
      if(!p || !p.place_id){
        setStatus('Aucun lieu sélectionné.', 'err');
        return;
      }
      // Détails complets
      const fields = [
        'place_id','name','formatted_address','geometry.location','url','website',
        'types','international_phone_number','opening_hours.weekday_text'
      ];
      placesService.getDetails({ placeId: p.place_id, fields }, (place, status)=>{
        if(status !== google.maps.places.PlacesServiceStatus.OK || !place){
          setStatus('Impossible de récupérer les détails du lieu.', 'err');
          return;
        }
        lastPlace = place;
        // Pré-remplir le nom magasin override
        const sn = $('#storeName'); if(sn && place.name) sn.value = place.name;
        renderPlaceSummary(place);
        setStatus('Lieu sélectionné. Vous pouvez générer le JSON.', 'ok');
      });
    }

    function renderPlaceSummary(place){
      const el = $('#placeSummary'); const body = $('#placeSummaryBody');
      if(!el || !body) return;
      const lat = place.geometry?.location?.lat?.(); // v3
      const lng = place.geometry?.location?.lng?.();
      const maps = place.url || (lat!=null && lng!=null ? `https://www.google.com/maps?q=${lat},${lng}` : null);
      const web  = place.website || null;
      body.innerHTML = `
        <div><strong>${place.name || '—'}</strong></div>
        <div>${place.formatted_address || '—'}</div>
        <div style="margin-top:6px">
          ${web ? `Site : <a href="${web}" target="_blank" rel="noopener">ouvrir</a> &nbsp;` : ``}
          ${maps ? `Maps : <a href="${maps}" target="_blank" rel="noopener">ouvrir</a>` : ``}
        </div>
        <div class="help" style="margin-top:6px">
          place_id : <code>${place.place_id}</code> •
          types : <code>${(place.types||[]).slice(0,4).join(', ')}</code>
        </div>
      `;
      el.style.display = 'block';
    }

    // --- Validation & construction JSON
    function validateInputs(){
      const enseigneSel = $('#enseigneSelect');
      const enseigneSlug = enseigneSel?.value || '';
      const enseigneNom  = (enseignes.find(e=>e.slug===enseigneSlug)?.nom) || enseigneSlug || '';
      const opType = $('#operationType')?.value || 'autre';
      const opLabel = $('#operationLabel')?.value?.trim() || '';
      const opStart = $('#opStart')?.value || '';
      const opEnd   = $('#opEnd')?.value || '';
      const storeNameOverride = $('#storeName')?.value?.trim() || '';

      const errs = [];
      if(!enseigneNom) errs.push('• Enseigne requise (liste vide ou non sélectionnée).');
      if(!lastPlace?.place_id) errs.push('• Sélectionnez un magasin via Google Places.');
      // Optionnel: dates cohérentes
      if(opStart && opEnd && opEnd < opStart) errs.push('• La date de fin est antérieure à la date de début.');

      return {
        ok: errs.length===0,
        errs,
        values: { enseigneNom, enseigneSlug, opType, opLabel, opStart, opEnd, storeNameOverride }
      };
    }

    function defaultSource(type='google_places', url=null){
      const s = { type, collected_at: new Date().toISOString() };
      if(type==='open_web' && url){ s.name='Site enseigne'; s.url=url; }
      if(type==='google_places'){ s.name='Places Details'; }
      return s;
    }

    function buildJSON(vals){
      const p = lastPlace || {};
      const loc = p.geometry?.location;
      const lat = typeof loc?.lat === 'function' ? loc.lat() : null;
      const lng = typeof loc?.lng === 'function' ? loc.lng() : null;
      const now = new Date().toISOString();

      const srcPlaces = defaultSource('google_places');
      const srcWeb = p.website ? defaultSource('open_web', p.website) : null;

      const storeName = vals.storeNameOverride || p.name || vals.enseigneNom;

      const json = {
        store_id: uuidv4(),
        enseigne: vals.enseigneNom,
        store_name: storeName,
        last_updated: now,
        goal: 'hybride',
        operation: {
          type: vals.opType,
          label_libre: vals.opLabel || undefined,
          date_debut: vals.opStart || undefined,
          date_fin: vals.opEnd || undefined
        },
        axes: {
          adresse_contexte: {
            google_places: {
              place_id: p.place_id || null,
              name: p.name || null,
              formatted_address: p.formatted_address || null,
              types: p.types || [],
              website: p.website || null,
              google_maps_url: p.url || null,
              international_phone_number: p.international_phone_number || null,
              opening_hours: p.opening_hours?.weekday_text || [],
              sources: [srcPlaces]
            },
            coordonnees: {
              latitude:  { value: lat, sources: [srcPlaces] },
              longitude: { value: lng, sources: [srcPlaces] }
            },
            adresse_postale: {
              value: p.formatted_address || null,
              sources: [srcPlaces]
            },
            references_ouvertes: [
              ...(p.website ? [{
                page_type: 'page_magasin_enseigne',
                title: `${storeName} — ${vals.enseigneNom}`,
                language: 'fr',
                url: p.website,
                source: srcWeb,
                collected_at: now
              }] : []),
              ...(p.url ? [{
                page_type: 'google_maps',
                title: 'Fiche Google Maps',
                language: 'fr',
                url: p.url,
                source: srcPlaces,
                collected_at: now
              }] : [])
            ]
          }
        }
      };
      return json;
    }

    function download(filename, text){
      const blob = new Blob([text], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // --- Envoi Webhook
    async function postToWebhook(){
      const rawWh = ($('#webhook')?.value || '').trim();
      const webhook = rawWh.replace(/\s+/g,'').replace(/\/+$/,'');
      if(!/^https?:\/\//i.test(webhook)){
        alert('URL du webhook n8n invalide'); return;
      }

      let payloadStr = lastPayloadStr;
      if(!payloadStr){
        const res = validateInputs();
        if(!res.ok){ alert("Données incomplètes : générez d'abord un JSON valide."); return; }
        const obj = buildJSON(res.values);
        payloadStr = JSON.stringify(obj);
        lastPayloadObj = obj;
        lastPayloadStr = payloadStr;
      }

      const btnPost = $('#btn-post'); const btnGen = $('#btn-gen');
      try{ localStorage.setItem('webhook_url', webhook); }catch(e){}

      try{
        btnPost && (btnPost.disabled = true);
        btnGen && (btnGen.disabled = true);
        setStatus('Envoi en cours… (fetch JSON)', 'info');
        const resp = await fetch(webhook, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: payloadStr,
          mode: 'cors',
          credentials: 'omit'
        });
        const txt = await resp.text().catch(()=> '');
        if(resp.ok){
          setStatus('Webhook envoyé ✅ (fetch JSON)', 'ok');
          try{
            const data = JSON.parse(txt);
            const vid = data.store_id;
            let html = '• ';
            if (vid) html += `<a href="viewer.html?id=${vid}" target="_blank" rel="noopener">Ouvrir dans le viewer</a><br>`;
            if (data.md_path) html += `• <a href="https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${data.md_path}" target="_blank">Markdown sur GitHub</a><br>`;
            if (data.json_path) html += `• <a href="https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${data.json_path}" target="_blank">JSON sur GitHub</a>`;
            showResults(html);
          }catch(e){}
          return;
        } else {
          console.warn('CORS/HTTP non OK, fallback Beacon :', resp.status, txt);
        }
      }catch(err){
        console.warn('fetch JSON échoué, fallback Beacon :', err);
      }finally{
        btnPost && (btnPost.disabled = false);
        btnGen && (btnGen.disabled = false);
      }

      try{
        setStatus('Envoi en cours… (fallback Beacon)', 'info');
        const blob = new Blob([payloadStr], { type: 'text/plain;charset=UTF-8' });
        const sent = navigator.sendBeacon(webhook, blob);
        if(sent){
          setStatus('Webhook envoyé ✅ (Beacon). Vérifiez n8n → Executions.', 'ok');
          alert('Webhook envoyé (Beacon). La réponse n’est pas lisible côté navigateur.');
        } else {
          setStatus("Échec d'envoi (Beacon)", 'err');
          alert("Échec d'envoi (Beacon)");
        }
      } catch(e){
        setStatus('Échec total de l\'envoi', 'err');
        alert('Échec total de l\'envoi : ' + (e?.message || e));
      }
    }

    // --- Génération JSON / actions
    $('#btn-gen').addEventListener('click', () => {
      const res = validateInputs();
      const $err = $('#errors');
      if(!res.ok){
        $err.style.display = 'block';
        $err.innerText = res.errs.join('\n');
        $('#preview').textContent = '(corrigez les erreurs puis regénérez)';
        $('#btn-copy').disabled = true;
        $('#btn-dl').disabled = true;
        $('#btn-post').disabled = true;
        return;
      }
      $err.style.display = 'none';
      const json = buildJSON(res.values);
      const pretty = JSON.stringify(json, null, 2);
      lastPayloadObj = json;
      lastPayloadStr = pretty;
      $('#btn-post').disabled = false;
      $('#btn-post').onclick = postToWebhook;
      $('#preview').textContent = pretty;
      $('#btn-copy').disabled = false;
      $('#btn-dl').disabled = false;
      $('#btn-dl').onclick = () => download(`store_profile_${res.values.enseigneSlug || 'magasin'}.json`, pretty);
      $('#btn-copy').onclick = async () => {
        try{ await navigator.clipboard.writeText(pretty); alert('JSON copié dans le presse-papiers') }
        catch(e){ alert('Copie impossible : permissions navigateur') }
      }
    });

    // --- Boot
    (function boot(){
      // webhook prérempli + bouton secret
      const i = $('#webhook');
      if(i){
        try{
          const saved = localStorage.getItem('webhook_url');
          i.value = saved || i.value;
        }catch(e){}
        const b = $('#btn-gen-secret');
        if(b) b.addEventListener('click', generateWebhookSecret);
      }
      // enseignes
      loadEnseignes();
      // init Google Places (callback se charge via script async)
      window.initPlaces = initPlaces;
    })();
  </script>

  <!-- Google Maps JavaScript API + Places (clé restreinte par referrer) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCy5VImTf6SPltnHqVetqh5GPCp-o_JmFo&libraries=places&callback=initPlaces"></script>
</body>
</html>
