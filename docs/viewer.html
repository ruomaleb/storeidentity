<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Viewer • Profil magasin</title>
<style>
  :root{--bg:#0b1320;--card:#121a2b;--muted:#7c8aa5;--text:#e6eefc;--accent:#4f8cff;--ok:#10b981;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,var(--bg) 0%,#0f172a 100%);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .container{max-width:980px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:rgba(11,19,32,.85);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #1f2a44}
  h1{font-size:18px;margin:0} .sub{color:#c7d7ff80;font-size:12px;margin:4px 0 0}
  section{background:#121a2b;border:1px solid #23304d;border-radius:16px;padding:16px;margin-top:16px}
  label{display:block;font-weight:600;margin-bottom:6px}
  input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a395c;background:#0e1526;color:#fff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a395c;background:#0b1320;color:#fff;cursor:pointer}
  .btn.primary{background:#4169e1;border-color:#4169e1}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #223156;background:#132038;border-radius:999px;padding:4px 10px;font-size:12px;color:#cfe0ff}
  .grid{display:grid;gap:12px} .cols-2{grid-template-columns:1fr 1fr}
  .help{color:#c7d7ff80;font-size:12px;margin-top:6px}
  pre{background:#0a1120;border:1px solid #1f2a44;border-radius:12px;padding:12px;overflow:auto;max-height:460px}
  a{color:#9cc1ff}
</style>
</head>
<body>
<header>
  <div class="container" style="padding:12px 20px;">
    <h1>Viewer — Profil magasin</h1>
    <p class="sub">Charge un portrait à partir des fichiers <code>profiles/&lt;store_id&gt;.json</code> et <code>.md</code> du dépôt.</p>
  </div>
</header>

<main class="container">
  <section>
    <div class="row" style="justify-content:space-between">
      <strong>Rechercher par <code>store_id</code></strong>
      <span class="pill" id="repoInfo">ruomaleb/storeidentity@main</span>
    </div>
    <div class="grid cols-2" style="margin-top:8px">
      <div>
        <label for="sid">store_id</label>
        <input id="sid" placeholder="ex : b7a9b515-aae7-4545-b37d-c902899b4fae" />
        <div class="help">Vous pouvez aussi ouvrir <code>/viewer.html?id=&lt;store_id&gt;</code> directement.</div>
      </div>
      <div class="row" style="align-items:flex-end">
        <button class="btn primary" id="btnLoad">Charger</button>
        <button class="btn" id="btnList">Lister les profils détectés</button>
      </div>
    </div>
    <div id="status" class="help" style="margin-top:8px;display:none"></div>
  </section>

  <section id="summary" style="display:none">
    <strong>Résumé</strong>
    <div id="summaryBody" class="grid cols-2" style="margin-top:8px"></div>
  </section>

  <section id="mdSection" style="display:none">
    <strong>Portrait rédigé (.md)</strong>
    <div class="help">Fichier : <a id="mdLink" target="_blank" rel="noopener">ouvrir sur GitHub</a></div>
    <div class="help">Astuce : cliquez “Raw” dans GitHub pour une vue sans mise en forme, ou clonez le repo.</div>
    <div class="divider" style="height:1px;background:#1f2a44;margin:8px 0"></div>
    <pre id="mdView">(chargement…)</pre>
  </section>

  <section id="jsonSection" style="display:none">
    <strong>JSON source</strong>
    <div class="help">Fichier : <a id="jsonLink" target="_blank" rel="noopener">ouvrir sur GitHub</a></div>
    <div class="divider" style="height:1px;background:#1f2a44;margin:8px 0"></div>
    <pre id="jsonView">(chargement…)</pre>
  </section>

  <section id="listSection" style="display:none">
    <strong>Profils disponibles (détectés via API GitHub)</strong>
    <div class="help">Cliquez pour ouvrir dans ce viewer.</div>
    <div id="listBody" class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));margin-top:8px"></div>
  </section>
</main>

<script>
const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
const RAW = (p)=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p}`;
const API = (p)=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
const $=s=>document.querySelector(s);
const el = id=>document.getElementById(id);

function setStatus(msg,type='info'){
  const s=el('status'); s.style.display='block';
  s.style.color = type==='ok'?'#a7f3d0':(type==='err'?'#fecaca':'#c7d7ff');
  s.textContent=msg;
}

async function fetchJson(path){
  // tente RAW puis fallback API contents (base64)
  try{
    const r = await fetch(RAW(path)); if(r.ok) return await r.json();
  }catch(_){}
  const r2 = await fetch(API(path));
  if(!r2.ok) throw new Error('GET contents API: '+r2.status);
  const data = await r2.json();
  if(data && data.content){
    const txt = atob(data.content.replace(/\\n/g,''));
    return JSON.parse(txt);
  }
  throw new Error('Contenu introuvable');
}

async function fetchText(path){
  try{ const r = await fetch(RAW(path)); if(r.ok) return await r.text(); }catch(_){}
  const r2 = await fetch(API(path));
  if(!r2.ok) throw new Error('GET contents API: '+r2.status);
  const data = await r2.json();
  if(data && data.download_url){
    const rr = await fetch(data.download_url);
    return await rr.text();
  }
  return '(vide)';
}

function mapSummary(j){
  const ref = j?.axes?.adresse_contexte?.references_ouvertes?.[0];
  const lat = j?.axes?.adresse_contexte?.coordonnees?.latitude?.value;
  const lng = j?.axes?.adresse_contexte?.coordonnees?.longitude?.value;
  const gmaps = (lat!=null && lng!=null) ? `https://www.google.com/maps?q=${lat},${lng}` : null;
  return [
    ['Enseigne', j?.enseigne || '—'],
    ['Magasin', j?.store_name || '—'],
    ['Store ID', j?.store_id || '—'],
    ['Adresse', j?.axes?.adresse_contexte?.adresse_postale?.value || '—'],
    ['Page enseigne', ref?.url ? `<a href="${ref.url}" target="_blank">ouvrir</a>` : '—'],
    ['Carto', gmaps ? `<a href="${gmaps}" target="_blank">ouvrir dans Maps</a>` : '—'],
    ['Dernière MAJ', j?.last_updated || '—'],
  ];
}

function renderSummary(j){
  const grid = el('summaryBody'); grid.innerHTML='';
  for(const [k,v] of mapSummary(j)){
    const box = document.createElement('div');
    box.innerHTML = `<div style="font-size:12px;color:#c7d7ff80">${k}</div><div style="margin-top:4px">${v}</div>`;
    grid.appendChild(box);
  }
  el('summary').style.display='block';
}

async function loadById(id){
  setStatus('Chargement du profil…');
  const jsonPath = `profiles/${id}.json`;
  const mdPath   = `profiles/${id}.md`;
  try{
    const j = await fetchJson(jsonPath);
    renderSummary(j);
    // JSON
    el('jsonView').textContent = JSON.stringify(j,null,2);
    el('jsonLink').href = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${jsonPath}`;
    el('jsonSection').style.display='block';
    // MD
    try{
      const md = await fetchText(mdPath);
      el('mdView').textContent = md;
      el('mdLink').href = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${mdPath}`;
      el('mdSection').style.display='block';
    }catch(e){ el('mdSection').style.display='none'; }
    setStatus('Profil chargé.', 'ok');
  }catch(e){
    setStatus('Impossible de charger ce store_id. Vérifiez le fichier JSON dans /profiles/.', 'err');
    console.error(e);
  }
}

async function listProfiles(){
  setStatus('Récupération de la liste des profils…');
  const r = await fetch(API('profiles'));
  if(!r.ok){ setStatus('Impossible de lister les fichiers (GitHub API).','err'); return; }
  const arr = await r.json();
  const list = arr.filter(x=>x.name.endsWith('.json'));
  const body = el('listBody'); body.innerHTML='';
  list.forEach(x=>{
    const id = x.name.replace(/\\.json$/,'');
    const a = document.createElement('a');
    a.href = `#`; a.onclick = (ev)=>{ev.preventDefault(); el('sid').value=id; loadById(id);};
    a.className='btn'; a.style.cssText='display:block;margin-bottom:8px';
    a.textContent = id;
    body.appendChild(a);
  });
  el('listSection').style.display='block';
  setStatus(`${list.length} profil(s) détecté(s).`,'ok');
}

document.getElementById('btnLoad').onclick = ()=>{ const id=el('sid').value.trim(); if(id) loadById(id); };
document.getElementById('btnList').onclick = listProfiles;

// support du query param ?id=
const params = new URLSearchParams(location.search);
const qid = params.get('id'); if(qid){ el('sid').value = qid; loadById(qid); }
</script>
</body>
</html>
