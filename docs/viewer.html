<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Viewer • Profil magasin</title>
<style>
  :root{--bg:#fff;--surface:#fff;--surface-alt:#f5f5f7;--text:#1d1d1f;--muted:#6e6e73;--border:#e5e5ea;
        --accent:#0a84ff;--ok:#34c759;--warn:#ffd60a;--err:#ff3b30}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{max-width:920px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--border);z-index:10}
  .hwrap{display:flex;align-items:end;justify-content:space-between;gap:12px;padding:14px 20px}
  h1{font-size:20px;font-weight:700;letter-spacing:-.01em;margin:0}
  .sub{color:var(--muted);font-size:13px;margin:4px 0 0}
  section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:16px}
  label{display:block;font-weight:600;margin-bottom:6px}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid #d2d2d7;background:#fff}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d2d2d7;background:var(--surface-alt);cursor:pointer}
  .btn:hover{background:#ebebf0}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);background:var(--surface-alt);border-radius:999px;padding:4px 10px;font-size:12px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .help{color:var(--muted);font-size:13px;margin-top:6px}
  pre{background:var(--surface-alt);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto;max-height:460px}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .chip{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;margin-right:6px;font-size:12px}
  .divider{height:1px;background:var(--border);margin:8px 0}
</style>
</head>
<body>
<header>
  <div class="hwrap container">
    <div>
      <h1>Viewer — Profil magasin</h1>
      <p class="sub">Charge un portrait depuis <code>profiles/&lt;store_id&gt;.json</code> (+ <code>.md</code> si présent).</p>
    </div>
    <span class="pill" id="repoInfo">ruomaleb/storeidentity@main</span>
  </div>
</header>

<main class="container">
  <section>
    <div class="row" style="justify-content:space-between">
      <strong>Rechercher par <code>store_id</code></strong>
    </div>
    <div class="grid cols-2" style="margin-top:8px">
      <div>
        <label for="sid">store_id</label>
        <input id="sid" placeholder="ex : b7a9b515-aae7-4545-b37d-c902899b4fae" />
        <div class="help">Ou ouvrez directement <code>/viewer.html?id=&lt;store_id&gt;</code>.</div>
      </div>
      <div class="row" style="align-items:flex-end">
        <button class="btn primary" id="btnLoad">Charger</button>
        <button class="btn" id="btnList">Lister les profils</button>
        <button class="btn ok" id="btnDuplicate" style="display:none">Dupliquer vers la saisie</button>
      </div>
    </div>
    <div id="status" class="help" style="margin-top:8px;display:none"></div>
  </section>

  <section id="summary" style="display:none">
    <strong>Résumé</strong>
    <div id="summaryBody" class="grid cols-2" style="margin-top:8px"></div>
  </section>

  <section id="opSection" style="display:none">
    <strong>Opération</strong>
    <div id="opBody" class="help" style="margin-top:8px"></div>
  </section>

  <section id="mdSection" style="display:none">
    <strong>Portrait rédigé (.md)</strong>
    <div class="help">Fichier : <a id="mdLink" target="_blank" rel="noopener">ouvrir sur GitHub</a></div>
    <div class="divider"></div>
    <pre id="mdView">(chargement…)</pre>
  </section>

  <section id="jsonSection" style="display:none">
    <strong>JSON source</strong>
    <div class="help">Fichier : <a id="jsonLink" target="_blank" rel="noopener">ouvrir sur GitHub</a></div>
    <div class="divider"></div>
    <pre id="jsonView">(chargement…)</pre>
  </section>

  <section id="listSection" style="display:none">
    <strong>Profils disponibles</strong>
    <div class="help">Cliquez un ID pour ouvrir dans ce viewer.</div>
    <div id="listBody" class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));margin-top:8px"></div>
  </section>
</main>

<script>
const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
const RAW = (p)=>`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${p}`;
const API = (p)=>`https://api.github.com/repos/${OWNER}/${REPO}/contents/${p}?ref=${BRANCH}`;
const $=s=>document.querySelector(s);
const el = id=>document.getElementById(id);

function setStatus(msg,type='info'){
  const s=el('status'); s.style.display='block';
  s.style.color = type==='ok'?'#34c759':(type==='err'?'#ff3b30':'#6e6e73');
  s.textContent=msg;
}

async function fetchJson(path){
  try{
    const r = await fetch(RAW(path)); if(r.ok) return await r.json();
  }catch(_){}
  const r2 = await fetch(API(path));
  if(!r2.ok) throw new Error('GET contents API: '+r2.status);
  const data = await r2.json();
  if(data && data.content){
    const txt = atob(data.content.replace(/\n/g,''));
    return JSON.parse(txt);
  }
  throw new Error('Contenu introuvable');
}

async function fetchText(path){
  try{ const r = await fetch(RAW(path)); if(r.ok) return await r.text(); }catch(_){}
  const r2 = await fetch(API(path));
  if(!r2.ok) throw new Error('GET contents API: '+r2.status);
  const data = await r2.json();
  if(data && data.download_url){
    const rr = await fetch(data.download_url);
    return await rr.text();
  }
  return '(vide)';
}

function fmtDate(d){
  if(!d) return '—';
  try{ const x = new Date(d); return x.toISOString().slice(0,10); }catch(_){ return d; }
}

function mapSummary(j){
  const ref = (j?.axes?.adresse_contexte?.references_ouvertes||[]).find(r=>r.page_type==='page_magasin_enseigne') || j?.axes?.adresse_contexte?.references_ouvertes?.[0];
  const lat = j?.axes?.adresse_contexte?.coordonnees?.latitude?.value;
  const lng = j?.axes?.adresse_contexte?.coordonnees?.longitude?.value;
  const gmaps = (lat!=null && lng!=null) ? `https://www.google.com/maps?q=${lat},${lng}` : (j?.axes?.adresse_contexte?.google_places?.google_maps_url || null);
  return [
    ['Enseigne', j?.enseigne || '—'],
    ['Magasin', j?.store_name || '—'],
    ['Store ID', j?.store_id || '—'],
    ['Adresse', j?.axes?.adresse_contexte?.adresse_postale?.value || '—'],
    ['Page enseigne', ref?.url ? `<a href="${ref.url}" target="_blank">ouvrir</a>` : '—'],
    ['Carto', gmaps ? `<a href="${gmaps}" target="_blank">ouvrir dans Maps</a>` : '—'],
    ['Dernière MAJ', j?.last_updated || '—'],
  ];
}

function renderSummary(j){
  const grid = el('summaryBody'); grid.innerHTML='';
  for(const [k,v] of mapSummary(j)){
    const box = document.createElement('div');
    box.innerHTML = `<div style="font-size:13px;color:#6e6e73">${k}</div><div style="margin-top:4px">${v}</div>`;
    grid.appendChild(box);
  }
  el('summary').style.display='block';
}

function renderOperation(j){
  const op = j?.operation || {};
  const chip = (t)=>`<span class="chip">${t}</span>`;
  const type = op.type ? chip(op.type) : chip('—');
  const label = op.label_libre ? chip(op.label_libre) : '';
  const kpis  = Array.isArray(op.kpi_focus) ? op.kpi_focus.map(chip).join(' ') : '';
  const d1 = fmtDate(op.date_debut); const d2 = fmtDate(op.date_fin);
  const body = el('opBody');
  body.innerHTML = `
    <div style="margin-bottom:6px">${type} ${label} ${kpis}</div>
    <div class="help">Période : ${d1} → ${d2}</div>
  `;
  el('opSection').style.display='block';
}

// ---- Duplication (préremplissage pour la page de saisie 5 champs)
function duplicateStore(j){
  const enseigne = j?.enseigne || '';
  const magasin  = j?.store_name || '';
  const adresse  = j?.axes?.adresse_contexte?.adresse_postale?.value || '';
  const lat = j?.axes?.adresse_contexte?.coordonnees?.latitude?.value;
  const lng = j?.axes?.adresse_contexte?.coordonnees?.longitude?.value;
  const ref = (j?.axes?.adresse_contexte?.references_ouvertes||[]).find(r=>r.page_type==='page_magasin_enseigne') || null;
  const url = ref?.url || '';

  const seed = { enseigne, magasin, adresse, url, coords: (lat!=null && lng!=null) ? `${lat}, ${lng}` : '' };
  try{ localStorage.setItem('si_prefill_legacy', JSON.stringify(seed)); }catch(e){}

  // Redirige vers la page de saisie
  location.href = 'index.html';
}

async function loadById(id){
  setStatus('Chargement du profil…');
  const jsonPath = `profiles/${id}.json`;
  const mdPath   = `profiles/${id}.md`;
  try{
    const j = await fetchJson(jsonPath);
    renderSummary(j);
    renderOperation(j);

    el('jsonView').textContent = JSON.stringify(j,null,2);
    el('jsonLink').href = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${jsonPath}`;
    el('jsonSection').style.display='block';

    try{
      const md = await fetchText(mdPath);
      el('mdView').textContent = md;
      el('mdLink').href = `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${mdPath}`;
      el('mdSection').style.display='block';
    }catch(e){ el('mdSection').style.display='none'; }

    const dup = document.getElementById('btnDuplicate');
    dup.style.display='inline-block';
    dup.onclick = ()=> duplicateStore(j);

    setStatus('Profil chargé.', 'ok');
  }catch(e){
    setStatus('Impossible de charger ce store_id. Vérifiez le JSON dans /profiles/.', 'err');
    console.error(e);
  }
}

async function listProfiles(){
  setStatus('Récupération de la liste…');
  const r = await fetch(API('profiles'));
  if(!r.ok){ setStatus('Impossible de lister les fichiers (GitHub API).','err'); return; }
  const arr = await r.json();
  const list = arr.filter(x=>x.name.endsWith('.json'));
  const body = el('listBody'); body.innerHTML='';
  list.forEach(x=>{
    const id = x.name.replace(/\.json$/,'');
    const a = document.createElement('a');
    a.href = `#`; a.onclick = (ev)=>{ev.preventDefault(); el('sid').value=id; loadById(id);};
    a.className='btn'; a.style.cssText='display:block;margin-bottom:8px';
    a.textContent = id;
    body.appendChild(a);
  });
  el('listSection').style.display='block';
  setStatus(`${list.length} profil(s) détecté(s).`,'ok');
}

document.getElementById('btnLoad').onclick = ()=>{ const id=el('sid').value.trim(); if(id) loadById(id); };
document.getElementById('btnList').onclick = listProfiles;

const params = new URLSearchParams(location.search);
const qid = params.get('id'); if(qid){ el('sid').value = qid; loadById(qid); }
</script>
</body>
</html>
