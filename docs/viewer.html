<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Viewer — Profil magasin</title>
<style>
  :root{--bg:#ffffff;--text:#1d1d1f;--muted:#6e6e73;--line:#e5e5ea;--accent:#0a84ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
  h1{font-size:20px;margin:0 0 4px}
  .sub{color:var(--muted);margin:0 0 8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input{padding:10px 12px;border:1px solid var(--line);border-radius:10px;min-width:260px}
  button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  section{margin-top:14px}
  .grid{display:grid;gap:14px}
  .cols-2{grid-template-columns:1fr 1fr}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#f5f5f7;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:170px 1fr;gap:6px 10px}
  pre{background:#0a0f1a;color:#e6eefc;border-radius:12px;padding:12px;overflow:auto;max-height:420px}
  .err{color:#c1121f}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>Viewer — Profil magasin</h1>
    <p class="sub">Charge un profil depuis le dépôt GitHub <span class="kbd" id="repoTag"></span></p>
    <div class="row" style="margin:10px 0 14px">
      <input id="inpId" placeholder="ID (ex. b7a9b515-aae7-4545-b37d-c902899b4fae)" />
      <button id="btnById" class="primary">Charger par ID</button>
      <input id="inpJson" placeholder="Chemin JSON (ex. profiles/<id>.json)" />
      <input id="inpMd" placeholder="Chemin MD (ex. profiles/<id>.md) — facultatif" />
      <button id="btnByPath">Charger par chemins</button>
      <button id="btnShare">Copier le lien viewer</button>
      <span class="muted" id="status"></span>
    </div>
  </div>
</header>

<main class="container">
  <section class="grid cols-2">
    <div class="card">
      <h3 style="margin-top:0">Résumé</h3>
      <div id="resume" class="kv">
        <div class="muted">Statut</div><div id="stat">—</div>
      </div>
      <div style="margin-top:10px" id="links"></div>
    </div>
    <div class="card">
      <h3 style="margin-top:0">Markdown</h3>
      <div id="md" class="muted">Aucun contenu markdown (fichier .md non trouvé).</div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">JSON brut</h3>
    <pre id="json">(en attente de chargement)</pre>
  </section>
</main>

<!-- Rendu Markdown via marked (léger) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" integrity="sha384-mh5wq2l8JHn3n5h2TgH8QpZ9d6WcM1I1m0r6JqW8GJq4y5VQWzj0wR8R3Cq7bZ6F" crossorigin="anonymous"></script>
<script>
(function(){
  // ------- Config dépôt -------
  const OWNER='ruomaleb', REPO='storeidentity', BRANCH='main';
  document.getElementById('repoTag').textContent = `${OWNER}/${REPO}@${BRANCH}`;

  // ------- Utilitaires -------
  const $ = s => document.querySelector(s);
  const status = (msg, type='info') => { const el=$('#status'); if(!el) return; el.textContent=msg; el.style.color=(type==='err'?'#c1121f':'#6e6e73'); }
  const q = new URLSearchParams(location.search);
  const toRaw = (path) => {
    const clean = (path||'').replace(/^\/+/,'');
    return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${clean}`;
  };
  const ghBlob = (path) => `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/${path.replace(/^\/+/,'')}`;

  async function fetchText(url){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status} — ${url}`);
    return r.text();
  }
  async function fetchJSON(url){
    const t = await fetchText(url);
    try { return JSON.parse(t); } catch(e){ throw new Error('JSON invalide'); }
  }

  function renderResume(obj){
    const R = $('#resume'); R.innerHTML = '';
    const rows = (k,v) => `<div class="muted">${k}</div><div>${v ?? '—'}</div>`;
    const addr = obj?.axes?.adresse_contexte?.adresse_postale?.value || '—';
    const lat  = obj?.axes?.adresse_contexte?.coordonnees?.latitude?.value;
    const lng  = obj?.axes?.adresse_contexte?.coordonnees?.longitude?.value;
    const maps = (lat!=null && lng!=null) ? `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">Google Maps</a>` : '—';
    const refs = (obj?.axes?.adresse_contexte?.references_ouvertes||[]).map(x=> {
      const title = x?.title || x?.url || 'référence';
      const url = x?.url || '#';
      return `<li><a href="${url}" target="_blank">${title}</a> <span class="muted">(${x?.page_type||'réf'})</span></li>`;
    }).join('') || '<li class="muted">aucune</li>';

    R.innerHTML = [
      rows('Enseigne', obj?.enseigne),
      rows('Magasin', obj?.store_name || obj?.magasin || '—'),
      rows('Adresse', addr),
      rows('Coordonnées', (lat!=null&&lng!=null)? `${lat}, ${lng}` : '—'),
      rows('Maps', maps),
      rows('Objectif', obj?.goal || '—'),
      rows('MAJ', obj?.last_updated || '—'),
      `<div class="muted">Références ouvertes</div><div><ul style="margin:6px 0 0 18px">${refs}</ul></div>`
    ].join('');
  }

  function renderJSON(obj){
    $('#json').textContent = JSON.stringify(obj, null, 2);
  }

  function renderLinks(jsonPath, mdPath){
    const el = $('#links');
    const parts = [];
    if(jsonPath) parts.push(`JSON : <a href="${ghBlob(jsonPath)}" target="_blank">ouvrir sur GitHub</a>`);
    if(mdPath)   parts.push(`MD : <a href="${ghBlob(mdPath)}" target="_blank">ouvrir sur GitHub</a>`);
    el.innerHTML = parts.join(' · ') || '<span class="muted">Aucun lien disponible.</span>';
  }

  async function load({id, jsonPath, mdPath}){
    try{
      status('Chargement…');

      // Déduire chemins si ID fourni
      if(id){
        jsonPath = jsonPath || `profiles/${id}.json`;
        mdPath   = mdPath   || `profiles/${id}.md`;
      }

      // Charger JSON
      const jsonUrl = toRaw(jsonPath);
      const obj = await fetchJSON(jsonUrl);
      renderResume(obj);
      renderJSON(obj);
      renderLinks(jsonPath, mdPath);
      status('JSON chargé', 'info');

      // Charger MD (silencieux si absent)
      if(mdPath){
        try{
          const md = await fetchText(toRaw(mdPath));
          $('#md').innerHTML = marked.parse(md);
        }catch(e){
          $('#md').innerHTML = '<span class="muted">Aucun contenu markdown (fichier .md non trouvé).</span>';
        }
      } else {
        $('#md').innerHTML = '<span class="muted">Aucun contenu markdown (non spécifié).</span>';
      }
    }catch(e){
      console.error(e);
      status('Erreur : ' + e.message, 'err');
      $('#json').textContent = '(échec de chargement)';
      $('#md').innerHTML = '<span class="err">Impossible de charger le contenu.</span>';
      $('#resume').innerHTML = '<div class="muted">—</div>';
    }
  }

  // ------- Interactions -------
  $('#btnById').addEventListener('click', ()=>{
    const id = $('#inpId').value.trim();
    if(!id) return status('Renseignez un ID', 'err');
    const url = new URL(location.href);
    url.search = '?id=' + encodeURIComponent(id);
    history.replaceState(null,'',url);
    load({id});
  });

  $('#btnByPath').addEventListener('click', ()=>{
    const j = $('#inpJson').value.trim();
    if(!j) return status('Renseignez au minimum le chemin JSON', 'err');
    const m = $('#inpMd').value.trim();
    const url = new URL(location.href);
    url.search = '?json=' + encodeURIComponent(j) + (m ? '&md=' + encodeURIComponent(m) : '');
    history.replaceState(null,'',url);
    load({jsonPath:j, mdPath:m||null});
  });

  $('#btnShare').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(location.href);
      status('Lien copié dans le presse-papiers');
    }catch{ status('Impossible de copier le lien', 'err') }
  });

  // ------- Auto-load via query string -------
  const id   = q.get('id');
  const jpth = q.get('json');
  const mpth = q.get('md');
  if(id){ $('#inpId').value = id; load({id}); }
  else if(jpth){ $('#inpJson').value=jpth; if(mpth) $('#inpMd').value=mpth; load({jsonPath:jpth, mdPath:mpth||null}); }
  else { status('Indiquez un ID ou des chemins de fichiers pour commencer.'); }
})();
</script>
</body>
</html>
